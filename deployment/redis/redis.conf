# ============================================
# Le Syndicat des Tox - Redis Configuration
# ============================================
# Secure Redis configuration for session storage and rate limiting
# Place in: /etc/redis/redis-syndicat.conf
# Run with: redis-server /etc/redis/redis-syndicat.conf

# ============================================
# Network Configuration
# ============================================

# Bind to localhost only (no external access)
bind 127.0.0.1 ::1

# Port
port 6379

# Timeout for idle clients (300 seconds = 5 minutes)
timeout 300

# TCP keepalive
tcp-keepalive 60

# ============================================
# Security
# ============================================

# CRITICAL: Set a strong password
# Generate with: openssl rand -base64 24
requirepass CHANGE_THIS_REDIS_PASSWORD

# Disable dangerous commands
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG ""
rename-command SHUTDOWN ""
rename-command BGREWRITEAOF ""
rename-command BGSAVE ""
rename-command DEBUG ""

# Protected mode (extra security)
protected-mode yes

# ============================================
# Memory Management
# ============================================

# Maximum memory (adjust based on your server)
# Recommendation: 256MB for small sites, 512MB for medium
maxmemory 256mb

# Eviction policy (remove least recently used keys when memory limit reached)
maxmemory-policy allkeys-lru

# Samples for LRU
maxmemory-samples 5

# ============================================
# Persistence
# ============================================

# Save database to disk
# Format: save <seconds> <changes>
save 900 1      # After 900 sec (15 min) if at least 1 key changed
save 300 10     # After 300 sec (5 min) if at least 10 keys changed
save 60 10000   # After 60 sec if at least 10000 keys changed

# Compression
rdbcompression yes

# Checksum
rdbchecksum yes

# Filename
dbfilename syndicat-tox-dump.rdb

# Directory (create this directory first)
dir /var/lib/redis/syndicat-tox

# Stop writes if save fails (safety)
stop-writes-on-bgsave-error yes

# ============================================
# Append-Only File (AOF)
# ============================================

# Enable AOF for better durability
appendonly yes

# AOF filename
appendfilename "syndicat-tox-appendonly.aof"

# Fsync policy (every second is good balance)
appendfsync everysec

# Rewrite AOF automatically
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# ============================================
# Performance
# ============================================

# Databases (we only need 2: 0 for prod, 1 for test)
databases 2

# Lazy freeing
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# Threading (if Redis 6+)
# io-threads 2
# io-threads-do-reads yes

# ============================================
# Logging
# ============================================

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file
logfile /var/log/redis/syndicat-tox.log

# Syslog
# syslog-enabled yes
# syslog-ident syndicat-tox

# ============================================
# Slow Log
# ============================================

# Log queries slower than 10ms
slowlog-log-slower-than 10000

# Keep last 128 slow queries
slowlog-max-len 128

# ============================================
# Client Limits
# ============================================

# Maximum number of connected clients
maxclients 100

# ============================================
# Advanced Configuration
# ============================================

# Disable THP (Transparent Huge Pages) warning
# Run: echo never > /sys/kernel/mm/transparent_hugepage/enabled

# Overcommit memory warning
# Add to /etc/sysctl.conf: vm.overcommit_memory = 1

# TCP backlog
tcp-backlog 511

# Replication (if using master-slave setup)
# replicaof <masterip> <masterport>
# masterauth <master-password>

# ============================================
# Monitoring
# ============================================

# Enable latency monitor
latency-monitor-threshold 100

# ============================================
# PRIVACY NOTE
# ============================================
# This Redis instance MUST NEVER store:
# - IP addresses
# - Personal identifying information
# - Unencrypted sensitive data
#
# Only store:
# - Session tokens (server-side only)
# - Anonymous rate limit counters
# - Temporary lockout data
