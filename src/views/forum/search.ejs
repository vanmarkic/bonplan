<%- include('../partials/header', { title: 'Recherche - Le Syndicat des Tox' }) %>

<!-- Breadcrumb navigation -->
<div style="margin-bottom: 1.5rem;">
    <a href="/forum/threads" style="color: #3498db; text-decoration: none;">‚Üê Retour aux discussions</a>
</div>

<h2>üîç Rechercher dans les discussions</h2>

<!-- Search form -->
<form method="GET" action="/forum/search" style="margin-bottom: 2rem;">
    <div class="form-group">
        <label for="q">Rechercher:</label>
        <div style="display: flex; gap: 0.5rem;">
            <input
                type="text"
                id="q"
                name="q"
                value="<%= typeof query !== 'undefined' ? query : '' %>"
                placeholder="Entrez vos mots-cl√©s..."
                minlength="2"
                maxlength="100"
                required
                style="flex: 1;"
            >
            <button type="submit" class="btn">
                üîç Rechercher
            </button>
        </div>
        <div class="text-small" style="margin-top: 0.5rem;">
            Recherchez par titre, contenu ou auteur (minimum 2 caract√®res)
        </div>
    </div>

    <!-- Advanced search options -->
    <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; color: #3498db;">Options avanc√©es</summary>
        <div style="margin-top: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 4px;">
            <div class="form-group">
                <label for="search_in">Rechercher dans:</label>
                <select id="search_in" name="search_in">
                    <option value="all" <%= searchIn === 'all' ? 'selected' : '' %>>Tout</option>
                    <option value="title" <%= searchIn === 'title' ? 'selected' : '' %>>Titres uniquement</option>
                    <option value="content" <%= searchIn === 'content' ? 'selected' : '' %>>Contenu uniquement</option>
                    <option value="replies" <%= searchIn === 'replies' ? 'selected' : '' %>>R√©ponses uniquement</option>
                </select>
            </div>

            <div class="form-group">
                <label for="language">Langue:</label>
                <select id="language" name="language">
                    <option value="all" <%= (!language || language === 'all') ? 'selected' : '' %>>Toutes les langues</option>
                    <option value="fr" <%= language === 'fr' ? 'selected' : '' %>>Fran√ßais</option>
                    <option value="nl" <%= language === 'nl' ? 'selected' : '' %>>Nederlands</option>
                    <option value="en" <%= language === 'en' ? 'selected' : '' %>>English</option>
                    <option value="de" <%= language === 'de' ? 'selected' : '' %>>Deutsch</option>
                </select>
            </div>

            <div class="form-group">
                <label for="sort_by">Trier par:</label>
                <select id="sort_by" name="sort_by">
                    <option value="relevance" <%= sortBy === 'relevance' ? 'selected' : '' %>>Pertinence</option>
                    <option value="newest" <%= sortBy === 'newest' ? 'selected' : '' %>>Plus r√©cent</option>
                    <option value="oldest" <%= sortBy === 'oldest' ? 'selected' : '' %>>Plus ancien</option>
                    <option value="replies" <%= sortBy === 'replies' ? 'selected' : '' %>>Plus de r√©ponses</option>
                </select>
            </div>

            <div class="form-group">
                <label for="date_range">P√©riode:</label>
                <select id="date_range" name="date_range">
                    <option value="all" <%= dateRange === 'all' ? 'selected' : '' %>>Toutes les dates</option>
                    <option value="today" <%= dateRange === 'today' ? 'selected' : '' %>>Aujourd'hui</option>
                    <option value="week" <%= dateRange === 'week' ? 'selected' : '' %>>Cette semaine</option>
                    <option value="month" <%= dateRange === 'month' ? 'selected' : '' %>>Ce mois</option>
                    <option value="year" <%= dateRange === 'year' ? 'selected' : '' %>>Cette ann√©e</option>
                </select>
            </div>
        </div>
    </details>
</form>

<!-- Search results -->
<% if (typeof query !== 'undefined' && query) { %>
    <% if (results && results.length > 0) { %>
        <div style="margin-bottom: 1.5rem;">
            <p><strong><%= totalResults %></strong> r√©sultat<%= totalResults !== 1 ? 's' : '' %> pour "<%= query %>"</p>
        </div>

        <div class="thread-list">
            <% results.forEach(result => { %>
                <div class="thread-item <%= result.isPinned ? 'pinned' : '' %>">
                    <div class="thread-title">
                        <a href="<%= result.type === 'reply' ? '/forum/threads/' + result.threadId + '#reply-' + result.id : '/forum/threads/' + result.id %>">
                            <% if (result.type === 'reply') { %>
                                üí¨ Re:
                            <% } %>
                            <%- highlightSearchTerms(result.title, query) %>
                        </a>
                    </div>

                    <div class="thread-meta">
                        <span>Par <%= result.author || '[supprim√©]' %></span>
                        <% if (result.isModerator) { %>
                            <span class="moderator-badge">üõ°Ô∏è Mod√©rateur</span>
                        <% } %>
                        <span> ‚Ä¢ <%= result.createdAt %></span>
                        <% if (result.type === 'thread') { %>
                            <span> ‚Ä¢ <%= result.replyCount || 0 %> r√©ponse<%= result.replyCount !== 1 ? 's' : '' %></span>
                        <% } %>
                        <% if (result.language && result.language !== 'fr') { %>
                            <span> ‚Ä¢ <%= getLanguageName(result.language) %></span>
                        <% } %>
                    </div>

                    <div class="thread-excerpt">
                        <%- highlightSearchTerms(result.excerpt, query) %>
                    </div>
                </div>
            <% }); %>
        </div>

        <!-- Pagination for search results -->
        <% if (totalPages && totalPages > 1) { %>
            <div class="pagination">
                <% const queryParams = `q=${encodeURIComponent(query)}&search_in=${searchIn}&language=${language}&sort_by=${sortBy}&date_range=${dateRange}`; %>

                <% if (currentPage > 1) { %>
                    <a href="/forum/search?<%= queryParams %>&page=1">¬´ D√©but</a>
                    <a href="/forum/search?<%= queryParams %>&page=<%= currentPage - 1 %>">‚Äπ Pr√©c√©dent</a>
                <% } %>

                <% for(let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
                    <% if (i === currentPage) { %>
                        <span class="current"><%= i %></span>
                    <% } else { %>
                        <a href="/forum/search?<%= queryParams %>&page=<%= i %>"><%= i %></a>
                    <% } %>
                <% } %>

                <% if (currentPage < totalPages) { %>
                    <a href="/forum/search?<%= queryParams %>&page=<%= currentPage + 1 %>">Suivant ‚Ä∫</a>
                    <a href="/forum/search?<%= queryParams %>&page=<%= totalPages %>">Fin ¬ª</a>
                <% } %>
            </div>
        <% } %>

    <% } else { %>
        <div class="no-results">
            <p style="font-size: 3rem; margin-bottom: 1rem;">üîç</p>
            <h3>Aucun r√©sultat trouv√©</h3>
            <p>Aucune discussion ne correspond √† votre recherche "<strong><%= query %></strong>"</p>
            <div style="margin-top: 1.5rem;">
                <p><strong>Suggestions:</strong></p>
                <ul style="text-align: left; display: inline-block; margin-top: 0.5rem;">
                    <li>V√©rifiez l'orthographe de vos mots-cl√©s</li>
                    <li>Essayez des mots-cl√©s plus g√©n√©raux</li>
                    <li>Essayez avec moins de mots</li>
                    <li>Changez les options de recherche avanc√©e</li>
                </ul>
            </div>
        </div>
    <% } %>
<% } else { %>
    <!-- No search performed yet -->
    <div style="text-align: center; padding: 2rem;">
        <p style="font-size: 3rem; margin-bottom: 1rem;">üîç</p>
        <p>Entrez vos mots-cl√©s pour rechercher dans les discussions</p>
    </div>

    <!-- Popular search terms -->
    <% if (typeof popularSearches !== 'undefined' && popularSearches && popularSearches.length > 0) { %>
        <div style="margin-top: 2rem;">
            <h3>Recherches populaires:</h3>
            <div style="margin-top: 1rem;">
                <% popularSearches.forEach(term => { %>
                    <a href="/forum/search?q=<%= encodeURIComponent(term) %>" class="btn btn-secondary" style="margin: 0.25rem;">
                        <%= term %>
                    </a>
                <% }); %>
            </div>
        </div>
    <% } %>
<% } %>

<!-- Helper functions (normally in backend, shown here for clarity) -->
<%
function highlightSearchTerms(text, searchQuery) {
    if (!text || !searchQuery) return text;

    const terms = searchQuery.split(' ').filter(term => term.length > 1);
    let highlightedText = text;

    terms.forEach(term => {
        const regex = new RegExp(`(${term})`, 'gi');
        highlightedText = highlightedText.replace(regex, '<span class="search-highlight">$1</span>');
    });

    return highlightedText;
}

function getLanguageName(code) {
    const languages = {
        'fr': 'Fran√ßais',
        'nl': 'Nederlands',
        'en': 'English',
        'de': 'Deutsch'
    };
    return languages[code] || code;
}
%>

<div class="alert alert-info" style="margin-top: 2rem;">
    <strong>üí° Astuce:</strong> Utilisez les guillemets pour rechercher une expression exacte, par exemple: "r√©duction des risques"
</div>

<%- include('../partials/footer') %>