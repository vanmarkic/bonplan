<%- include('../partials/header', { title: 'Tableau de bord de mod√©ration - Le Syndicat des Tox' }) %>

<!-- Breadcrumb navigation -->
<div style="margin-bottom: 1.5rem;">
    <a href="/forum/threads" style="color: #3498db; text-decoration: none;">‚Üê Retour aux discussions</a>
</div>

<h2>üõ°Ô∏è Tableau de bord de mod√©ration</h2>

<% if (!user || !user.isModerator) { %>
    <div class="alert alert-error">
        <strong>Acc√®s refus√©</strong>
        <p>Cette page est r√©serv√©e aux mod√©rateurs.</p>
        <a href="/forum/threads" class="btn btn-secondary" style="margin-top: 0.5rem;">Retour aux discussions</a>
    </div>
<% } else { %>

    <!-- Moderation stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div style="background: #fee; padding: 1rem; border-radius: 4px; border: 1px solid #fcc;">
            <h3 style="margin: 0; color: #c00;">‚ö†Ô∏è Signalements</h3>
            <p style="font-size: 2rem; margin: 0.5rem 0; font-weight: bold;"><%= stats.reportedCount || 0 %></p>
            <p style="margin: 0; font-size: 0.875rem; color: #999;">√Ä traiter</p>
        </div>

        <div style="background: #ffe; padding: 1rem; border-radius: 4px; border: 1px solid #ffc;">
            <h3 style="margin: 0; color: #f39c12;">üìå √âpingl√©s</h3>
            <p style="font-size: 2rem; margin: 0.5rem 0; font-weight: bold;"><%= stats.pinnedCount || 0 %></p>
            <p style="margin: 0; font-size: 0.875rem; color: #999;">Discussions</p>
        </div>

        <div style="background: #f0f0f0; padding: 1rem; border-radius: 4px; border: 1px solid #ddd;">
            <h3 style="margin: 0; color: #7f8c8d;">üîí Verrouill√©s</h3>
            <p style="font-size: 2rem; margin: 0.5rem 0; font-weight: bold;"><%= stats.lockedCount || 0 %></p>
            <p style="margin: 0; font-size: 0.875rem; color: #999;">Discussions</p>
        </div>

        <div style="background: #efe; padding: 1rem; border-radius: 4px; border: 1px solid #cfc;">
            <h3 style="margin: 0; color: #27ae60;">‚úÖ Trait√©s</h3>
            <p style="font-size: 2rem; margin: 0.5rem 0; font-weight: bold;"><%= stats.resolvedToday || 0 %></p>
            <p style="margin: 0; font-size: 0.875rem; color: #999;">Aujourd'hui</p>
        </div>
    </div>

    <!-- Tabs navigation -->
    <div style="border-bottom: 2px solid #ecf0f1; margin-bottom: 2rem;">
        <div style="display: flex; gap: 1rem;">
            <button onclick="showTab('reported')" id="tab-reported" class="btn btn-secondary" style="border-radius: 4px 4px 0 0; border-bottom: 2px solid transparent;">
                ‚ö†Ô∏è Signalements (<%= reportedItems ? reportedItems.length : 0 %>)
            </button>
            <button onclick="showTab('hidden')" id="tab-hidden" class="btn btn-secondary" style="border-radius: 4px 4px 0 0; border-bottom: 2px solid transparent;">
                üëÅÔ∏è Contenu masqu√© (<%= hiddenItems ? hiddenItems.length : 0 %>)
            </button>
            <button onclick="showTab('pinned')" id="tab-pinned" class="btn btn-secondary" style="border-radius: 4px 4px 0 0; border-bottom: 2px solid transparent;">
                üìå Discussions √©pingl√©es (<%= pinnedThreads ? pinnedThreads.length : 0 %>)
            </button>
            <button onclick="showTab('logs')" id="tab-logs" class="btn btn-secondary" style="border-radius: 4px 4px 0 0; border-bottom: 2px solid transparent;">
                üìã Journal d'activit√©
            </button>
        </div>
    </div>

    <!-- Tab content: Reported items -->
    <div id="content-reported" class="tab-content">
        <h3>Contenu signal√©</h3>

        <% if (reportedItems && reportedItems.length > 0) { %>
            <% reportedItems.forEach(item => { %>
                <div class="moderation-item reported">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0;">
                                <% if (item.type === 'thread') { %>
                                    üìÑ Discussion:
                                <% } else { %>
                                    üí¨ R√©ponse:
                                <% } %>
                                <a href="<%= item.type === 'thread' ? '/forum/threads/' + item.id : '/forum/threads/' + item.threadId + '#reply-' + item.id %>" target="_blank">
                                    <%= item.title || 'Sans titre' %>
                                </a>
                            </h4>

                            <div class="thread-meta">
                                <span>Auteur: <strong><%= item.author || '[supprim√©]' %></strong></span>
                                <span> ‚Ä¢ Signal√© le: <%= item.reportedAt %></span>
                                <span> ‚Ä¢ Nombre de signalements: <strong style="color: #e74c3c;"><%= item.reportCount || 1 %></strong></span>
                            </div>

                            <div style="margin: 1rem 0;">
                                <strong>Raisons des signalements:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    <% if (item.reportReasons && item.reportReasons.length > 0) { %>
                                        <% item.reportReasons.forEach(reason => { %>
                                            <li>
                                                <%= getReason(reason.reason) %>
                                                <% if (reason.details) { %>
                                                    : "<%= reason.details %>"
                                                <% } %>
                                                <span class="text-small">(par <%= reason.reporter || 'anonyme' %>)</span>
                                            </li>
                                        <% }); %>
                                    <% } else { %>
                                        <li>Pas de d√©tails disponibles</li>
                                    <% } %>
                                </ul>
                            </div>

                            <div style="background: #f9f9f9; padding: 0.75rem; border-radius: 4px; margin: 1rem 0;">
                                <strong>Extrait du contenu:</strong>
                                <p style="margin: 0.5rem 0 0 0;">
                                    <%= item.excerpt ? item.excerpt.substring(0, 300) : '[Contenu non disponible]' %>
                                    <%= item.excerpt && item.excerpt.length > 300 ? '...' : '' %>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                        <strong>Actions:</strong>
                        <div style="margin-top: 0.5rem;">
                            <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'dismiss')" class="btn btn-secondary">
                                ‚úÖ Ignorer (pas de probl√®me)
                            </button>
                            <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'hide')" class="btn btn-warning">
                                üëÅÔ∏è Masquer le contenu
                            </button>
                            <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'delete')" class="btn btn-danger">
                                üóëÔ∏è Supprimer d√©finitivement
                            </button>
                            <% if (item.type === 'thread') { %>
                                <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'lock')" class="btn btn-warning">
                                    üîí Verrouiller la discussion
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="no-results">
                <p style="font-size: 2rem;">‚úÖ</p>
                <p>Aucun contenu signal√© √† traiter!</p>
            </div>
        <% } %>
    </div>

    <!-- Tab content: Hidden items -->
    <div id="content-hidden" class="tab-content" style="display: none;">
        <h3>Contenu masqu√©</h3>

        <% if (hiddenItems && hiddenItems.length > 0) { %>
            <% hiddenItems.forEach(item => { %>
                <div class="moderation-item">
                    <h4>
                        <% if (item.type === 'thread') { %>
                            üìÑ Discussion:
                        <% } else { %>
                            üí¨ R√©ponse:
                        <% } %>
                        <%= item.title || 'Sans titre' %>
                    </h4>

                    <div class="thread-meta">
                        <span>Auteur: <%= item.author || '[supprim√©]' %></span>
                        <span> ‚Ä¢ Masqu√© le: <%= item.hiddenAt %></span>
                        <span> ‚Ä¢ Par: <%= item.moderatedBy %></span>
                    </div>

                    <div style="margin-top: 1rem;">
                        <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'unhide')" class="btn btn-secondary">
                            üëÅÔ∏è Rendre visible
                        </button>
                        <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'delete')" class="btn btn-danger">
                            üóëÔ∏è Supprimer d√©finitivement
                        </button>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="no-results">
                <p>Aucun contenu masqu√©</p>
            </div>
        <% } %>
    </div>

    <!-- Tab content: Pinned threads -->
    <div id="content-pinned" class="tab-content" style="display: none;">
        <h3>Discussions √©pingl√©es</h3>

        <% if (pinnedThreads && pinnedThreads.length > 0) { %>
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong>Note:</strong> Les discussions √©pingl√©es apparaissent en haut de la liste des discussions.
                Limitez-vous √† 3-5 discussions √©pingl√©es maximum pour une meilleure exp√©rience utilisateur.
            </div>

            <% pinnedThreads.forEach(thread => { %>
                <div class="moderation-item">
                    <h4>
                        <a href="/forum/threads/<%= thread.id %>" target="_blank">
                            üìå <%= thread.title %>
                        </a>
                    </h4>

                    <div class="thread-meta">
                        <span>Auteur: <%= thread.author || '[supprim√©]' %></span>
                        <span> ‚Ä¢ √âpingl√© le: <%= thread.pinnedAt %></span>
                        <span> ‚Ä¢ <%= thread.replyCount || 0 %> r√©ponses</span>
                    </div>

                    <div style="margin-top: 1rem;">
                        <button onclick="moderateItem('thread', '<%= thread.id %>', 'unpin')" class="btn btn-secondary">
                            üìå D√©s√©pingler
                        </button>
                        <% if (!thread.isLocked) { %>
                            <button onclick="moderateItem('thread', '<%= thread.id %>', 'lock')" class="btn btn-warning">
                                üîí Verrouiller
                            </button>
                        <% } %>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="no-results">
                <p>Aucune discussion √©pingl√©e</p>
                <a href="/forum/threads" class="btn btn-secondary" style="margin-top: 1rem;">
                    Parcourir les discussions
                </a>
            </div>
        <% } %>
    </div>

    <!-- Tab content: Activity logs -->
    <div id="content-logs" class="tab-content" style="display: none;">
        <h3>Journal d'activit√© de mod√©ration (derni√®res 48h)</h3>

        <% if (activityLogs && activityLogs.length > 0) { %>
            <div style="max-height: 500px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #ecf0f1;">
                            <th style="padding: 0.5rem; text-align: left;">Date/Heure</th>
                            <th style="padding: 0.5rem; text-align: left;">Mod√©rateur</th>
                            <th style="padding: 0.5rem; text-align: left;">Action</th>
                            <th style="padding: 0.5rem; text-align: left;">Cible</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% activityLogs.forEach(log => { %>
                            <tr style="border-bottom: 1px solid #ecf0f1;">
                                <td style="padding: 0.5rem;"><%= log.timestamp %></td>
                                <td style="padding: 0.5rem;"><%= log.moderator %></td>
                                <td style="padding: 0.5rem;">
                                    <span class="<%= getActionClass(log.action) %>">
                                        <%= getActionLabel(log.action) %>
                                    </span>
                                </td>
                                <td style="padding: 0.5rem;">
                                    <% if (log.targetUrl) { %>
                                        <a href="<%= log.targetUrl %>" target="_blank">
                                            <%= log.targetTitle || 'Voir' %>
                                        </a>
                                    <% } else { %>
                                        <%= log.targetTitle || 'N/A' %>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div class="no-results">
                <p>Aucune activit√© de mod√©ration r√©cente</p>
            </div>
        <% } %>
    </div>

    <!-- Moderation guidelines -->
    <div class="alert alert-info" style="margin-top: 2rem;">
        <h4>üìã Principes de mod√©ration</h4>
        <ul style="margin: 0.5rem 0 0 1.5rem;">
            <li>Privil√©giez toujours la bienveillance et le dialogue</li>
            <li>Ne supprimez que le contenu clairement dangereux ou ill√©gal</li>
            <li>Respectez les principes de r√©duction des risques</li>
            <li>En cas de doute, consultez les autres mod√©rateurs</li>
            <li>Documentez vos actions importantes dans le journal</li>
        </ul>
    </div>

<% } %>

<!-- Helper functions -->
<%
function getReason(reason) {
    const reasons = {
        'spam': 'Spam',
        'inappropriate': 'Contenu inappropri√©',
        'harassment': 'Harc√®lement',
        'misinformation': 'D√©sinformation dangereuse',
        'other': 'Autre'
    };
    return reasons[reason] || reason;
}

function getActionLabel(action) {
    const actions = {
        'dismiss': 'Ignor√©',
        'hide': 'Masqu√©',
        'unhide': 'Rendu visible',
        'delete': 'Supprim√©',
        'lock': 'Verrouill√©',
        'unlock': 'D√©verrouill√©',
        'pin': '√âpingl√©',
        'unpin': 'D√©s√©pingl√©'
    };
    return actions[action] || action;
}

function getActionClass(action) {
    if (['delete', 'hide', 'lock'].includes(action)) return 'text-danger';
    if (['dismiss', 'unhide', 'unlock'].includes(action)) return 'text-success';
    return '';
}
%>

<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    // Remove active class from all buttons
    document.querySelectorAll('[id^="tab-"]').forEach(btn => {
        btn.style.background = '#95a5a6';
        btn.style.borderBottom = '2px solid transparent';
    });

    // Show selected tab
    document.getElementById('content-' + tabName).style.display = 'block';

    // Mark button as active
    const activeBtn = document.getElementById('tab-' + tabName);
    activeBtn.style.background = '#3498db';
    activeBtn.style.borderBottom = '2px solid #3498db';
}

function moderateItem(type, id, action) {
    let confirmMsg = 'Confirmer cette action: ' + action + '?';

    if (action === 'delete') {
        confirmMsg = 'ATTENTION: Cette action est irr√©versible! Confirmer la suppression?';
    }

    if (confirm(confirmMsg)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/forum/moderation/action';

        const typeInput = document.createElement('input');
        typeInput.type = 'hidden';
        typeInput.name = 'type';
        typeInput.value = type;

        const idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'id';
        idInput.value = id;

        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = action;

        form.appendChild(typeInput);
        form.appendChild(idInput);
        form.appendChild(actionInput);
        document.body.appendChild(form);
        form.submit();
    }
}

// Initialize first tab
document.addEventListener('DOMContentLoaded', function() {
    showTab('reported');
});
</script>

<style>
.text-danger { color: #e74c3c; font-weight: 600; }
.text-success { color: #27ae60; font-weight: 600; }
.text-warning { color: #f39c12; font-weight: 600; }
</style>

<%- include('../partials/footer') %>