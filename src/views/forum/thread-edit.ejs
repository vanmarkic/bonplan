<%- include('../partials/header', { title: 'Modifier la discussion - Le Syndicat des Tox' }) %>

<!-- Breadcrumb navigation -->
<div style="margin-bottom: 1.5rem;">
    <a href="/forum/threads/<%= thread.id %>" style="color: #3498db; text-decoration: none;">‚Üê Retour √† la discussion</a>
</div>

<h2>Modifier la discussion</h2>

<% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">
        <%= error %>
    </div>
<% } %>

<% if (thread.editTimeRemaining) { %>
    <div class="alert alert-info" style="margin-bottom: 2rem;">
        <strong>‚è±Ô∏è Temps restant pour modifier:</strong> <%= thread.editTimeRemaining %>
        <p style="margin-top: 0.5rem; font-size: 0.875rem;">
            Apr√®s ce d√©lai, vous ne pourrez plus modifier votre message.
        </p>
    </div>
<% } else { %>
    <div class="alert alert-error" style="margin-bottom: 2rem;">
        <strong>‚ö†Ô∏è D√©lai de modification expir√©</strong>
        <p style="margin-top: 0.5rem;">
            Le d√©lai de 15 minutes pour modifier cette discussion est √©coul√©.
            Seuls les mod√©rateurs peuvent maintenant intervenir en cas de probl√®me.
        </p>
        <a href="/forum/threads/<%= thread.id %>" class="btn btn-secondary" style="margin-top: 0.5rem;">Retour √† la discussion</a>
    </div>
<% } %>

<% if (thread.canEdit) { %>
    <form method="POST" action="/forum/threads/<%= thread.id %>/edit" onsubmit="return validateForm()">
        <input type="hidden" name="_method" value="PUT">

        <div class="form-group">
            <label for="title">Titre de la discussion: *</label>
            <input
                type="text"
                id="title"
                name="title"
                required
                minlength="5"
                maxlength="200"
                value="<%= thread.title %>"
                onkeyup="updateTitleCount()"
            >
            <div class="char-counter">
                <span id="title-count">0</span> / 200 caract√®res (minimum 5)
            </div>
        </div>

        <div class="form-group">
            <label for="content">Votre message: *</label>
            <textarea
                id="content"
                name="content"
                required
                minlength="10"
                maxlength="10000"
                rows="12"
                onkeyup="updateContentCount()"
            ><%= thread.content %></textarea>
            <div class="char-counter">
                <span id="content-count">0</span> / 10000 caract√®res (minimum 10)
            </div>
        </div>

        <div class="form-group">
            <label for="language">Langue de la discussion:</label>
            <select id="language" name="language">
                <option value="fr" <%= thread.language === 'fr' ? 'selected' : '' %>>Fran√ßais</option>
                <option value="nl" <%= thread.language === 'nl' ? 'selected' : '' %>>Nederlands</option>
                <option value="en" <%= thread.language === 'en' ? 'selected' : '' %>>English</option>
                <option value="de" <%= thread.language === 'de' ? 'selected' : '' %>>Deutsch</option>
            </select>
        </div>

        <div class="form-group">
            <label for="edit_reason">Raison de la modification (optionnel):</label>
            <input
                type="text"
                id="edit_reason"
                name="edit_reason"
                maxlength="100"
                placeholder="Ex: Correction d'une faute de frappe, ajout d'informations..."
            >
            <div class="text-small">
                Cette information sera visible dans l'historique des modifications
            </div>
        </div>

        <div style="margin-top: 2rem;">
            <button type="submit" class="btn">
                ‚úÖ Enregistrer les modifications
            </button>
            <button type="button" onclick="if(confirm('Abandonner les modifications?')) { window.location.href='/forum/threads/<%= thread.id %>'; }" class="btn btn-secondary" style="margin-left: 1rem;">
                ‚ùå Annuler
            </button>
        </div>
    </form>

    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #ccc;">
        <h3 style="color: #e74c3c;">Zone dangereuse</h3>
        <p style="margin-bottom: 1rem;">Cette action est irr√©versible:</p>
        <button onclick="deleteThread()" class="btn btn-danger">
            üóëÔ∏è Supprimer d√©finitivement cette discussion
        </button>
    </div>
<% } %>

<script>
// Initialize character counters on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTitleCount();
    updateContentCount();
    startEditTimer();
});

function updateTitleCount() {
    const input = document.getElementById('title');
    const count = input.value.length;
    const counter = document.getElementById('title-count');
    counter.textContent = count;

    const container = counter.parentElement;
    container.className = 'char-counter';

    if (count < 5) {
        container.className = 'char-counter error';
    } else if (count > 180) {
        container.className = 'char-counter warning';
    } else if (count > 195) {
        container.className = 'char-counter error';
    }
}

function updateContentCount() {
    const textarea = document.getElementById('content');
    const count = textarea.value.length;
    const counter = document.getElementById('content-count');
    counter.textContent = count;

    const container = counter.parentElement;
    container.className = 'char-counter';

    if (count < 10) {
        container.className = 'char-counter error';
    } else if (count > 9000) {
        container.className = 'char-counter warning';
    } else if (count > 9900) {
        container.className = 'char-counter error';
    }
}

function validateForm() {
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;

    if (title.trim().length < 5) {
        alert('Le titre doit contenir au moins 5 caract√®res.');
        return false;
    }

    if (content.trim().length < 10) {
        alert('Le message doit contenir au moins 10 caract√®res.');
        return false;
    }

    return confirm('Enregistrer les modifications?');
}

function deleteThread() {
    const confirmMsg = 'ATTENTION: Cette action est IRR√âVERSIBLE!\n\n' +
                      '√ätes-vous absolument certain de vouloir supprimer cette discussion?\n' +
                      'Toutes les r√©ponses seront √©galement supprim√©es.';

    if (confirm(confirmMsg)) {
        if (confirm('Derni√®re chance: Confirmer la suppression?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/forum/threads/<%= thread.id %>/delete';
            const method = document.createElement('input');
            method.type = 'hidden';
            method.name = '_method';
            method.value = 'DELETE';
            form.appendChild(method);
            document.body.appendChild(form);
            form.submit();
        }
    }
}

function startEditTimer() {
    <% if (thread.editTimeRemainingSeconds) { %>
        let seconds = <%= thread.editTimeRemainingSeconds %>;
        const timerElement = document.querySelector('.alert-info strong');

        if (timerElement) {
            const interval = setInterval(function() {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(interval);
                    window.location.reload();
                } else {
                    const minutes = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    const timeStr = minutes > 0
                        ? `${minutes} minute${minutes !== 1 ? 's' : ''} ${secs} seconde${secs !== 1 ? 's' : ''}`
                        : `${secs} seconde${secs !== 1 ? 's' : ''}`;
                    timerElement.textContent = '‚è±Ô∏è Temps restant pour modifier: ' + timeStr;

                    // Change alert color when time is running out
                    if (seconds < 60) {
                        timerElement.parentElement.className = 'alert alert-error';
                    } else if (seconds < 180) {
                        timerElement.parentElement.style.background = '#fff3cd';
                        timerElement.parentElement.style.borderColor = '#ffc107';
                        timerElement.parentElement.style.color = '#856404';
                    }
                }
            }, 1000);
        }
    <% } %>
}
</script>

<%- include('../partials/footer') %>