version: '3.8'

# ============================================
# Le Syndicat des Tox - Docker Compose
# ============================================
# Development environment with MariaDB, Redis, and Node.js
# Usage:
#   Start: docker-compose up -d
#   Stop:  docker-compose down
#   Logs:  docker-compose logs -f
#   Shell: docker-compose exec app bash

services:
  # ============================================
  # MariaDB Database
  # ============================================
  database:
    image: mariadb:10.11
    container_name: syndicat-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-syndicat_tox}
      MYSQL_USER: ${DB_USER:-syndicat_app}
      MYSQL_PASSWORD: ${DB_PASSWORD:-devpassword}
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./docs/DATABASE_SCHEMA.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max-connections=100
      - --innodb-buffer-pool-size=256M
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - syndicat-network

  # ============================================
  # Redis (Sessions & Cache)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: syndicat-redis
    restart: unless-stopped
    command:
      - redis-server
      - --requirepass
      - ${REDIS_PASSWORD:-devredispassword}
      - --maxmemory
      - 256mb
      - --maxmemory-policy
      - allkeys-lru
      - --appendonly
      - yes
      - --save
      - "900 1"
      - --save
      - "300 10"
      - --save
      - "60 10000"
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - syndicat-network

  # ============================================
  # Node.js Application
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: syndicat-app
    restart: unless-stopped
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      HOST: 0.0.0.0

      # Database
      DB_HOST: database
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-syndicat_tox}
      DB_USER: ${DB_USER:-syndicat_app}
      DB_PASSWORD: ${DB_PASSWORD:-devpassword}

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-devredispassword}
      REDIS_DB: 0

      # Security
      SESSION_SECRET: ${SESSION_SECRET:-dev_secret_change_in_production}

      # Application
      APP_DOMAIN: ${APP_DOMAIN:-localhost}
      HTTPS_ONLY: false
      TRUST_PROXY: true
      LOG_LEVEL: debug
    ports:
      - "3000:3000"
    volumes:
      - ./src:/app/src:ro
      - ./views:/app/views:ro
      - ./public:/app/public:ro
      - ./logs:/app/logs
      - node_modules:/app/node_modules
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - syndicat-network

  # ============================================
  # Nginx Reverse Proxy (Development)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: syndicat-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deployment/nginx/dev.conf:/etc/nginx/conf.d/default.conf:ro
      - ./public:/var/www/syndicat-tox/public:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - app
    networks:
      - syndicat-network

# ============================================
# Volumes
# ============================================
volumes:
  mariadb_data:
    driver: local
  redis_data:
    driver: local
  node_modules:
    driver: local
  nginx_logs:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  syndicat-network:
    driver: bridge
