<%- include('../partials/header', { title: t('threadNew.pageTitle') }) %>

<!-- Breadcrumb navigation -->
<div style="margin-bottom: 1.5rem;">
    <a href="/threads" style="color: #3498db; text-decoration: none;">‚Üê <%= t('actions.back') %> <%= t('forum.threads').toLowerCase() %></a>
</div>

<h2><%= t('threadNew.title') %></h2>

<% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">
        <%= error %>
    </div>
<% } %>

<div class="alert alert-info" style="margin-bottom: 2rem;">
    <strong>üìù <%= t('threadNew.tipsTitle') %></strong>
    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
        <li><%= t('threadNew.tip1') %></li>
        <li><%= t('threadNew.tip2') %></li>
        <li><%= t('threadNew.tip3') %></li>
        <li><%= t('threadNew.tip4') %></li>
    </ul>
</div>

<form method="POST" action="/threads/new" onsubmit="return validateForm()">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <div class="form-group">
        <label for="title"><%= t('threadNew.threadTitle') %>: *</label>
        <input
            type="text"
            id="title"
            name="title"
            required
            minlength="5"
            maxlength="200"
            placeholder="<%= t('threadNew.threadTitlePlaceholder') %>"
            value="<%= typeof formData !== 'undefined' && formData.title ? formData.title : '' %>"
            onkeyup="updateTitleCount()"
        >
        <div class="char-counter">
            <span id="title-count">0</span> / 200 <%= t('threadNew.characters') %> (<%= t('threadNew.minimum') %> 5)
        </div>
    </div>

    <div class="form-group">
        <label for="body"><%= t('threadNew.yourMessage') %>: *</label>
        <textarea
            id="body"
            name="body"
            required
            minlength="10"
            maxlength="10000"
            rows="12"
            placeholder="<%= t('threadNew.messagePlaceholder') %>"
            onkeyup="updateContentCount()"
        ><%= typeof formData !== 'undefined' && formData.body ? formData.body : '' %></textarea>
        <div class="char-counter">
            <span id="content-count">0</span> / 10000 <%= t('threadNew.characters') %> (<%= t('threadNew.minimum') %> 10)
        </div>
    </div>

    <div class="form-group">
        <label for="language"><%= t('threadNew.threadLanguage') %>:</label>
        <select id="language" name="language">
            <option value="fr" <%= (!formData || formData.language === 'fr') ? 'selected' : '' %>><%= t('languages.fr') %></option>
            <option value="nl" <%= (formData && formData.language === 'nl') ? 'selected' : '' %>><%= t('languages.nl') %></option>
            <option value="en" <%= (formData && formData.language === 'en') ? 'selected' : '' %>><%= t('languages.en') %></option>
            <option value="de" <%= (formData && formData.language === 'de') ? 'selected' : '' %>><%= t('languages.de') %></option>
        </select>
    </div>

    <div class="form-group">
        <label style="display: flex; align-items: center; cursor: pointer;">
            <input
                type="checkbox"
                name="anonymous"
                id="anonymous"
                style="width: auto; margin-right: 0.5rem;"
                <%= (formData && formData.anonymous) ? 'checked' : '' %>
            >
            <span><%= t('threadNew.publishAnonymous') %></span>
        </label>
    </div>

    <div style="margin-top: 2rem;">
        <button type="submit" class="btn">
            ‚úÖ <%= t('threadNew.publishThread') %>
        </button>
        <button type="button" onclick="if(confirm('<%= t('threadNew.abandonConfirm') %>')) { window.location.href='/threads'; }" class="btn btn-secondary" style="margin-left: 1rem;">
            ‚ùå <%= t('actions.cancel') %>
        </button>
    </div>
</form>

<div class="alert alert-info" style="margin-top: 2rem;">
    <strong>‚ö†Ô∏è <%= t('threadNew.importantReminder') %></strong>
    <p style="margin-top: 0.5rem;">
        <%= t('threadNew.editWindow') %>
    </p>
</div>

<script>
// Initialize character counters on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTitleCount();
    updateContentCount();
});

function updateTitleCount() {
    const input = document.getElementById('title');
    const count = input.value.length;
    const counter = document.getElementById('title-count');
    counter.textContent = count;

    const container = counter.parentElement;
    container.className = 'char-counter';

    if (count < 5) {
        container.className = 'char-counter error';
    } else if (count > 180) {
        container.className = 'char-counter warning';
    } else if (count > 195) {
        container.className = 'char-counter error';
    }
}

function updateContentCount() {
    const textarea = document.getElementById('body');
    const count = textarea.value.length;
    const counter = document.getElementById('content-count');
    counter.textContent = count;

    const container = counter.parentElement;
    container.className = 'char-counter';

    if (count < 10) {
        container.className = 'char-counter error';
    } else if (count > 9000) {
        container.className = 'char-counter warning';
    } else if (count > 9900) {
        container.className = 'char-counter error';
    }
}

function validateForm() {
    const title = document.getElementById('title').value;
    const body = document.getElementById('body').value;

    if (title.trim().length < 5) {
        alert('<%= t('threadNew.titleTooShort') %>');
        return false;
    }

    if (body.trim().length < 10) {
        alert('<%= t('threadNew.messageTooShort') %>');
        return false;
    }

    // Confirmation for sensitive topics
    const sensitiveWords = ['suicide', 'overdose', 'OD', 'mort'];
    const combinedText = (title + ' ' + body).toLowerCase();

    for (const word of sensitiveWords) {
        if (combinedText.includes(word.toLowerCase())) {
            const confirmMsg = '<%= t('threadNew.sensitiveWarning') %>';
            return confirm(confirmMsg);
        }
    }

    return true;
}
</script>

<%- include('../partials/footer') %>