<%- include('../partials/header', { title: t('moderationDashboard.pageTitle') }) %>

<!-- Breadcrumb navigation -->
<div style="margin-bottom: 1.5rem;">
    <a href="/forum/threads" style="color: #3498db; text-decoration: none;">‚Üê <%= t('actions.back') %> <%= t('forum.threads').toLowerCase() %></a>
</div>

<h2>üõ°Ô∏è <%= t('moderationDashboard.title') %></h2>

<% if (!user || !user.isModerator) { %>
    <div class="alert alert-error">
        <strong><%= t('moderationDashboard.accessDenied') %></strong>
        <p><%= t('moderationDashboard.moderatorsOnly') %></p>
        <a href="/forum/threads" class="btn btn-secondary" style="margin-top: 0.5rem;"><%= t('actions.back') %> <%= t('forum.threads').toLowerCase() %></a>
    </div>
<% } else { %>

    <!-- Moderation stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div style="background: #fee; padding: 1rem; border-radius: 4px; border: 1px solid #fcc;">
            <h3 style="margin: 0; color: #c00;">‚ö†Ô∏è <%= t('moderationDashboard.reports') %></h3>
            <p style="font-size: 2rem; margin: 0.5rem 0; font-weight: bold;"><%= stats.reportedCount || 0 %></p>
            <p style="margin: 0; font-size: 0.875rem; color: #999;"><%= t('moderationDashboard.toProcess') %></p>
        </div>

        <div style="background: #ffe; padding: 1rem; border-radius: 4px; border: 1px solid #ffc;">
            <h3 style="margin: 0; color: #f39c12;">üìå <%= t('moderationDashboard.pinned') %></h3>
            <p style="font-size: 2rem; margin: 0.5rem 0; font-weight: bold;"><%= stats.pinnedCount || 0 %></p>
            <p style="margin: 0; font-size: 0.875rem; color: #999;"><%= t('moderationDashboard.threads') %></p>
        </div>

        <div style="background: #f0f0f0; padding: 1rem; border-radius: 4px; border: 1px solid #ddd;">
            <h3 style="margin: 0; color: #7f8c8d;">üîí <%= t('moderationDashboard.locked') %></h3>
            <p style="font-size: 2rem; margin: 0.5rem 0; font-weight: bold;"><%= stats.lockedCount || 0 %></p>
            <p style="margin: 0; font-size: 0.875rem; color: #999;"><%= t('moderationDashboard.threads') %></p>
        </div>

        <div style="background: #efe; padding: 1rem; border-radius: 4px; border: 1px solid #cfc;">
            <h3 style="margin: 0; color: #27ae60;">‚úÖ <%= t('moderationDashboard.resolved') %></h3>
            <p style="font-size: 2rem; margin: 0.5rem 0; font-weight: bold;"><%= stats.resolvedToday || 0 %></p>
            <p style="margin: 0; font-size: 0.875rem; color: #999;"><%= t('moderationDashboard.today') %></p>
        </div>
    </div>

    <!-- Tabs navigation -->
    <div style="border-bottom: 2px solid #ecf0f1; margin-bottom: 2rem;">
        <div style="display: flex; gap: 1rem;">
            <button onclick="showTab('reported')" id="tab-reported" class="btn btn-secondary" style="border-radius: 4px 4px 0 0; border-bottom: 2px solid transparent;">
                ‚ö†Ô∏è <%= t('moderationDashboard.reportedTab') %> (<%= reportedItems ? reportedItems.length : 0 %>)
            </button>
            <button onclick="showTab('hidden')" id="tab-hidden" class="btn btn-secondary" style="border-radius: 4px 4px 0 0; border-bottom: 2px solid transparent;">
                üëÅÔ∏è <%= t('moderationDashboard.hiddenTab') %> (<%= hiddenItems ? hiddenItems.length : 0 %>)
            </button>
            <button onclick="showTab('pinned')" id="tab-pinned" class="btn btn-secondary" style="border-radius: 4px 4px 0 0; border-bottom: 2px solid transparent;">
                üìå <%= t('moderationDashboard.pinnedTab') %> (<%= pinnedThreads ? pinnedThreads.length : 0 %>)
            </button>
            <button onclick="showTab('logs')" id="tab-logs" class="btn btn-secondary" style="border-radius: 4px 4px 0 0; border-bottom: 2px solid transparent;">
                üìã <%= t('moderationDashboard.logsTab') %>
            </button>
        </div>
    </div>

    <!-- Tab content: Reported items -->
    <div id="content-reported" class="tab-content">
        <h3><%= t('moderationDashboard.reportedContent') %></h3>

        <% if (reportedItems && reportedItems.length > 0) { %>
            <% reportedItems.forEach(item => { %>
                <div class="moderation-item reported">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 0.5rem 0;">
                                <% if (item.type === 'thread') { %>
                                    üìÑ <%= t('moderationDashboard.thread') %>:
                                <% } else { %>
                                    üí¨ <%= t('moderationDashboard.reply') %>:
                                <% } %>
                                <a href="<%= item.type === 'thread' ? '/forum/threads/' + item.id : '/forum/threads/' + item.threadId + '#reply-' + item.id %>" target="_blank">
                                    <%= item.title || t('moderationDashboard.noTitle') %>
                                </a>
                            </h4>

                            <div class="thread-meta">
                                <span><%= t('moderationDashboard.author') %>: <strong><%= item.author || t('forum.deleted') %></strong></span>
                                <span> ‚Ä¢ <%= t('moderationDashboard.reportedOn') %>: <%= item.reportedAt %></span>
                                <span> ‚Ä¢ <%= t('moderationDashboard.reportCount') %>: <strong style="color: #e74c3c;"><%= item.reportCount || 1 %></strong></span>
                            </div>

                            <div style="margin: 1rem 0;">
                                <strong><%= t('moderationDashboard.reportReasons') %>:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    <% if (item.reportReasons && item.reportReasons.length > 0) { %>
                                        <% item.reportReasons.forEach(reason => { %>
                                            <li>
                                                <%= getReason(reason.reason) %>
                                                <% if (reason.details) { %>
                                                    : "<%= reason.details %>"
                                                <% } %>
                                                <span class="text-small">(<%= t('moderationDashboard.by') %> <%= reason.reporter || t('moderationDashboard.anonymous') %>)</span>
                                            </li>
                                        <% }); %>
                                    <% } else { %>
                                        <li><%= t('moderationDashboard.noDetails') %></li>
                                    <% } %>
                                </ul>
                            </div>

                            <div style="background: #f9f9f9; padding: 0.75rem; border-radius: 4px; margin: 1rem 0;">
                                <strong><%= t('moderationDashboard.excerpt') %>:</strong>
                                <p style="margin: 0.5rem 0 0 0;">
                                    <%= item.excerpt ? item.excerpt.substring(0, 300) : t('moderationDashboard.noContent') %>
                                    <%= item.excerpt && item.excerpt.length > 300 ? '...' : '' %>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
                        <strong><%= t('moderationDashboard.actions') %>:</strong>
                        <div style="margin-top: 0.5rem;">
                            <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'dismiss')" class="btn btn-secondary">
                                ‚úÖ <%= t('moderationDashboard.dismiss') %>
                            </button>
                            <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'hide')" class="btn btn-warning">
                                üëÅÔ∏è <%= t('moderationDashboard.hideContent') %>
                            </button>
                            <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'delete')" class="btn btn-danger">
                                üóëÔ∏è <%= t('moderationDashboard.deletePermanently') %>
                            </button>
                            <% if (item.type === 'thread') { %>
                                <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'lock')" class="btn btn-warning">
                                    üîí <%= t('moderationDashboard.lockThread') %>
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="no-results">
                <p style="font-size: 2rem;">‚úÖ</p>
                <p><%= t('moderationDashboard.noReportedContent') %></p>
            </div>
        <% } %>
    </div>

    <!-- Tab content: Hidden items -->
    <div id="content-hidden" class="tab-content" style="display: none;">
        <h3><%= t('moderationDashboard.hiddenContent') %></h3>

        <% if (hiddenItems && hiddenItems.length > 0) { %>
            <% hiddenItems.forEach(item => { %>
                <div class="moderation-item">
                    <h4>
                        <% if (item.type === 'thread') { %>
                            üìÑ <%= t('moderationDashboard.thread') %>:
                        <% } else { %>
                            üí¨ <%= t('moderationDashboard.reply') %>:
                        <% } %>
                        <%= item.title || t('moderationDashboard.noTitle') %>
                    </h4>

                    <div class="thread-meta">
                        <span><%= t('moderationDashboard.author') %>: <%= item.author || t('forum.deleted') %></span>
                        <span> ‚Ä¢ <%= t('moderationDashboard.hiddenOn') %>: <%= item.hiddenAt %></span>
                        <span> ‚Ä¢ <%= t('moderationDashboard.by') %>: <%= item.moderatedBy %></span>
                    </div>

                    <div style="margin-top: 1rem;">
                        <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'unhide')" class="btn btn-secondary">
                            üëÅÔ∏è <%= t('moderationDashboard.makeVisible') %>
                        </button>
                        <button onclick="moderateItem('<%= item.type %>', '<%= item.id %>', 'delete')" class="btn btn-danger">
                            üóëÔ∏è <%= t('moderationDashboard.deletePermanently') %>
                        </button>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="no-results">
                <p><%= t('moderationDashboard.noHiddenContent') %></p>
            </div>
        <% } %>
    </div>

    <!-- Tab content: Pinned threads -->
    <div id="content-pinned" class="tab-content" style="display: none;">
        <h3><%= t('moderationDashboard.pinnedThreads') %></h3>

        <% if (pinnedThreads && pinnedThreads.length > 0) { %>
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <strong><%= t('moderationDashboard.note') %>:</strong> <%= t('moderationDashboard.pinnedNote') %>
            </div>

            <% pinnedThreads.forEach(thread => { %>
                <div class="moderation-item">
                    <h4>
                        <a href="/forum/threads/<%= thread.id %>" target="_blank">
                            üìå <%= thread.title %>
                        </a>
                    </h4>

                    <div class="thread-meta">
                        <span><%= t('moderationDashboard.author') %>: <%= thread.author || t('forum.deleted') %></span>
                        <span> ‚Ä¢ <%= t('moderationDashboard.pinnedOn') %>: <%= thread.pinnedAt %></span>
                        <span> ‚Ä¢ <%= thread.replyCount || 0 %> <%= thread.replyCount !== 1 ? t('forum.replies') : t('forum.reply') %></span>
                    </div>

                    <div style="margin-top: 1rem;">
                        <button onclick="moderateItem('thread', '<%= thread.id %>', 'unpin')" class="btn btn-secondary">
                            üìå <%= t('moderationDashboard.unpin') %>
                        </button>
                        <% if (!thread.isLocked) { %>
                            <button onclick="moderateItem('thread', '<%= thread.id %>', 'lock')" class="btn btn-warning">
                                üîí <%= t('moderationDashboard.lock') %>
                            </button>
                        <% } %>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="no-results">
                <p><%= t('moderationDashboard.noPinnedThreads') %></p>
                <a href="/forum/threads" class="btn btn-secondary" style="margin-top: 1rem;">
                    <%= t('moderationDashboard.browseThreads') %>
                </a>
            </div>
        <% } %>
    </div>

    <!-- Tab content: Activity logs -->
    <div id="content-logs" class="tab-content" style="display: none;">
        <h3><%= t('moderationDashboard.activityLog') %></h3>

        <% if (activityLogs && activityLogs.length > 0) { %>
            <div style="max-height: 500px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #ecf0f1;">
                            <th style="padding: 0.5rem; text-align: left;"><%= t('moderationDashboard.dateTime') %></th>
                            <th style="padding: 0.5rem; text-align: left;"><%= t('moderationDashboard.moderator') %></th>
                            <th style="padding: 0.5rem; text-align: left;"><%= t('moderationDashboard.action') %></th>
                            <th style="padding: 0.5rem; text-align: left;"><%= t('moderationDashboard.target') %></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% activityLogs.forEach(log => { %>
                            <tr style="border-bottom: 1px solid #ecf0f1;">
                                <td style="padding: 0.5rem;"><%= log.timestamp %></td>
                                <td style="padding: 0.5rem;"><%= log.moderator %></td>
                                <td style="padding: 0.5rem;">
                                    <span class="<%= getActionClass(log.action) %>">
                                        <%= getActionLabel(log.action) %>
                                    </span>
                                </td>
                                <td style="padding: 0.5rem;">
                                    <% if (log.targetUrl) { %>
                                        <a href="<%= log.targetUrl %>" target="_blank">
                                            <%= log.targetTitle || t('moderationDashboard.view') %>
                                        </a>
                                    <% } else { %>
                                        <%= log.targetTitle || 'N/A' %>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        <% } else { %>
            <div class="no-results">
                <p><%= t('moderationDashboard.noActivity') %></p>
            </div>
        <% } %>
    </div>

    <!-- Moderation guidelines -->
    <div class="alert alert-info" style="margin-top: 2rem;">
        <h4>üìã <%= t('moderationDashboard.guidelines') %></h4>
        <ul style="margin: 0.5rem 0 0 1.5rem;">
            <li><%= t('moderationDashboard.guideline1') %></li>
            <li><%= t('moderationDashboard.guideline2') %></li>
            <li><%= t('moderationDashboard.guideline3') %></li>
            <li><%= t('moderationDashboard.guideline4') %></li>
            <li><%= t('moderationDashboard.guideline5') %></li>
        </ul>
    </div>

<% } %>

<!-- Helper functions -->
<%
function getReason(reason) {
    const reasons = {
        'spam': 'Spam',
        'inappropriate': 'Contenu inappropri√©',
        'harassment': 'Harc√®lement',
        'misinformation': 'D√©sinformation dangereuse',
        'other': 'Autre'
    };
    return reasons[reason] || reason;
}

function getActionLabel(action) {
    const actions = {
        'dismiss': 'Ignor√©',
        'hide': 'Masqu√©',
        'unhide': 'Rendu visible',
        'delete': 'Supprim√©',
        'lock': 'Verrouill√©',
        'unlock': 'D√©verrouill√©',
        'pin': '√âpingl√©',
        'unpin': 'D√©s√©pingl√©'
    };
    return actions[action] || action;
}

function getActionClass(action) {
    if (['delete', 'hide', 'lock'].includes(action)) return 'text-danger';
    if (['dismiss', 'unhide', 'unlock'].includes(action)) return 'text-success';
    return '';
}
%>

<script>
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });

    // Remove active class from all buttons
    document.querySelectorAll('[id^="tab-"]').forEach(btn => {
        btn.style.background = '#95a5a6';
        btn.style.borderBottom = '2px solid transparent';
    });

    // Show selected tab
    document.getElementById('content-' + tabName).style.display = 'block';

    // Mark button as active
    const activeBtn = document.getElementById('tab-' + tabName);
    activeBtn.style.background = '#3498db';
    activeBtn.style.borderBottom = '2px solid #3498db';
}

function moderateItem(type, id, action) {
    let confirmMsg = '<%= t('moderationDashboard.confirmAction') %>: ' + action + '?';

    if (action === 'delete') {
        confirmMsg = '<%= t('moderationDashboard.deleteWarning') %>';
    }

    if (confirm(confirmMsg)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/forum/moderation/action';

        const typeInput = document.createElement('input');
        typeInput.type = 'hidden';
        typeInput.name = 'type';
        typeInput.value = type;

        const idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'id';
        idInput.value = id;

        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = action;

        form.appendChild(typeInput);
        form.appendChild(idInput);
        form.appendChild(actionInput);
        document.body.appendChild(form);
        form.submit();
    }
}

// Initialize first tab
document.addEventListener('DOMContentLoaded', function() {
    showTab('reported');
});
</script>

<style>
.text-danger { color: #e74c3c; font-weight: 600; }
.text-success { color: #27ae60; font-weight: 600; }
.text-warning { color: #f39c12; font-weight: 600; }
</style>

<%- include('../partials/footer') %>