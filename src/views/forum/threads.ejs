<%- include('../partials/header', { title: 'Discussions - Le Syndicat des Tox', language: typeof language !== 'undefined' ? language : 'fr' }) %>

<h2><%= t('forum.threads') %></h2>

<!-- Toolbar with new thread button and sorting options -->
<div class="toolbar">
    <% if (typeof user !== 'undefined' && user) { %>
        <a href="/threads/new" class="btn">‚úçÔ∏è <%= t('forum.newThread') %></a>
    <% } else { %>
        <div>
            <a href="/auth/login" class="btn btn-secondary"><%= t('nav.login') %></a>
        </div>
    <% } %>

    <div class="sort-options">
        <span style="margin-right: 0.5rem; color: #7f8c8d;"><%= t('forum.sortBy') %>:</span>
        <a href="/threads?sort=recent" class="<%= filters.sort === 'recent' ? 'active' : '' %>"><%= t('forum.sortActivity') %></a>
        <a href="/threads?sort=newest" class="<%= filters.sort === 'newest' ? 'active' : '' %>"><%= t('forum.sortNewest') %></a>
        <a href="/threads?sort=replies" class="<%= filters.sort === 'replies' ? 'active' : '' %>"><%= t('forum.sortReplies') %></a>
    </div>
</div>

<!-- Thread list -->
<div class="thread-list">
    <% if (threads && threads.length > 0) { %>
        <% threads.forEach(thread => { %>
            <div class="thread-item <%= thread.isPinned ? 'pinned' : '' %>">
                <div class="thread-title">
                    <a href="/forum/threads/<%= thread.id %>">
                        <%= thread.title %>
                    </a>
                </div>

                <div class="thread-meta">
                    <span><%= t('forum.author') %>: <%= thread.author || t('forum.deleted') %></span>
                    <% if (thread.isModerator) { %>
                        <span class="moderator-badge">üõ°Ô∏è <%= t('moderation.moderator') %></span>
                    <% } %>
                    <span> ‚Ä¢ <%= thread.replyCount || 0 %> <%= thread.replyCount !== 1 ? t('forum.replies').toLowerCase() : t('forum.reply').toLowerCase() %></span>
                    <span> ‚Ä¢ <%= t('forum.lastActivity') %>: <%= thread.lastActivity || thread.createdAt %></span>
                </div>

                <% if (thread.excerpt) { %>
                    <div class="thread-excerpt">
                        <%= thread.excerpt.substring(0, 200) %><%= thread.excerpt.length > 200 ? '...' : '' %>
                    </div>
                <% } %>
            </div>
        <% }); %>
    <% } else { %>
        <div class="no-results">
            <p style="font-size: 3rem; margin-bottom: 1rem;">ü§∑</p>
            <h3><%= t('forum.noThreads') %></h3>
            <p><%= t('community.welcome') %></p>
            <% if (typeof user !== 'undefined' && user) { %>
                <a href="/forum/threads/new" class="btn" style="margin-top: 1rem;"><%= t('forum.createThread') %></a>
            <% } %>
        </div>
    <% } %>
</div>

<!-- Pagination -->
<% if (pagination && pagination.total > 1) { %>
    <div class="pagination">
        <% if (pagination.hasPrev) { %>
            <a href="/threads?page=1&sort=<%= filters.sort %>">¬´</a>
            <a href="/threads?page=<%= pagination.current - 1 %>&sort=<%= filters.sort %>">‚Äπ <%= t('pagination.previous') %></a>
        <% } %>

        <% for(let i = Math.max(1, pagination.current - 2); i <= Math.min(pagination.total, pagination.current + 2); i++) { %>
            <% if (i === pagination.current) { %>
                <span class="current"><%= i %></span>
            <% } else { %>
                <a href="/threads?page=<%= i %>&sort=<%= filters.sort %>"><%= i %></a>
            <% } %>
        <% } %>

        <% if (pagination.hasNext) { %>
            <a href="/threads?page=<%= pagination.current + 1 %>&sort=<%= filters.sort %>"><%= t('pagination.next') %> ‚Ä∫</a>
            <a href="/threads?page=<%= pagination.total %>&sort=<%= filters.sort %>">¬ª</a>
        <% } %>
    </div>
<% } %>

<div class="alert alert-info" style="margin-top: 2rem;">
    <strong><%= t('community.guidelines') %>:</strong> <%= t('community.safeSpace') %>. <%= t('community.respectful') %>. <%= t('community.harmReduction') %>.
</div>

<%- include('../partials/footer', { language: typeof language !== 'undefined' ? language : 'fr' }) %>