version: '3.8'

# ============================================
# Le Syndicat des Tox - Production Docker Compose
# ============================================
# Production environment with security hardening, resource limits, and monitoring
# Usage:
#   Start: docker-compose -f docker-compose.prod.yml up -d
#   Stop:  docker-compose -f docker-compose.prod.yml down
#   Logs:  docker-compose -f docker-compose.prod.yml logs -f
#   Scale: docker-compose -f docker-compose.prod.yml up -d --scale app=3

services:
  # ============================================
  # MariaDB Database (Production)
  # ============================================
  database:
    image: mariadb:10.11
    container_name: syndicat-db-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "127.0.0.1:3306:3306"  # Bind only to localhost
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./docs/DATABASE_SCHEMA.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ./backups/database:/backups
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max-connections=150
      - --innodb-buffer-pool-size=512M
      - --innodb-log-file-size=128M
      - --innodb-flush-method=O_DIRECT
      - --innodb-file-per-table=1
      - --query-cache-size=0
      - --query-cache-type=0
      - --local-infile=0
      - --skip-symbolic-links
      - --log-error=/var/log/mysql/error.log
      - --slow-query-log=1
      - --slow-query-log-file=/var/log/mysql/slow.log
      - --long-query-time=2
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - syndicat-network
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - DAC_OVERRIDE
      - SETUID
      - SETGID

  # ============================================
  # Redis (Sessions & Cache - Production)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: syndicat-redis-prod
    restart: always
    command:
      - redis-server
      - --requirepass
      - ${REDIS_PASSWORD}
      - --maxmemory
      - 512mb
      - --maxmemory-policy
      - allkeys-lru
      - --appendonly
      - yes
      - --appendfsync
      - everysec
      - --save
      - "900 1"
      - --save
      - "300 10"
      - --save
      - "60 10000"
      - --tcp-backlog
      - "511"
      - --timeout
      - "300"
      - --tcp-keepalive
      - "60"
      - --loglevel
      - notice
      - --databases
      - "2"
    ports:
      - "127.0.0.1:6379:6379"  # Bind only to localhost
    volumes:
      - redis_data:/data
      - ./backups/redis:/backups
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - syndicat-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETUID
      - SETGID

  # ============================================
  # Node.js Application (Production)
  # ============================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: syndicat-tox:latest
    container_name: syndicat-app-prod
    restart: always
    environment:
      NODE_ENV: production
      PORT: 3000
      HOST: 0.0.0.0

      # Database
      DB_HOST: database
      DB_PORT: 3306
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0

      # Security
      SESSION_SECRET: ${SESSION_SECRET}

      # Application
      APP_DOMAIN: ${APP_DOMAIN}
      HTTPS_ONLY: true
      TRUST_PROXY: true
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # Rate Limiting
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-100}

      # Features
      FEATURE_REGISTRATION: ${FEATURE_REGISTRATION:-true}
      FEATURE_SEARCH: ${FEATURE_SEARCH:-true}
      FEATURE_REPORTING: ${FEATURE_REPORTING:-true}
      FEATURE_MODERATION: ${FEATURE_MODERATION:-true}

    ports:
      - "127.0.0.1:3000:3000"  # Bind only to localhost
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads  # If user uploads are implemented
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - syndicat-network
    deploy:
      mode: replicated
      replicas: 2
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        monitor: 60s
        order: start-first
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp
      - /app/.npm

  # ============================================
  # Nginx Reverse Proxy (Production)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: syndicat-nginx-prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deployment/nginx/prod.conf:/etc/nginx/conf.d/default.conf:ro
      - ./deployment/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./public:/var/www/syndicat-tox/public:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
      - nginx_cache:/var/cache/nginx
    depends_on:
      - app
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - syndicat-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "10"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID

  # ============================================
  # Monitoring - Prometheus (Optional)
  # ============================================
  # Uncomment to enable Prometheus monitoring
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: syndicat-prometheus
  #   restart: always
  #   ports:
  #     - "127.0.0.1:9090:9090"
  #   volumes:
  #     - ./deployment/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus_data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--storage.tsdb.retention.time=30d'
  #   networks:
  #     - syndicat-network
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.5'
  #         memory: 512M
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"

# ============================================
# Volumes
# ============================================
volumes:
  mariadb_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/syndicat-tox/mariadb
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/syndicat-tox/redis
  nginx_logs:
    driver: local
  nginx_cache:
    driver: local
  # prometheus_data:
  #   driver: local

# ============================================
# Networks
# ============================================
networks:
  syndicat-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.25.0.0/16
    driver_opts:
      com.docker.network.bridge.name: br-syndicat
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.driver.mtu: "1500"
