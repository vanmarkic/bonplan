<%- include('../partials/header', { title: t('search.pageTitle') }) %>

<!-- Breadcrumb navigation -->
<div style="margin-bottom: 1.5rem;">
    <a href="/forum/threads" style="color: #3498db; text-decoration: none;">‚Üê <%= t('actions.back') %> <%= t('forum.threads').toLowerCase() %></a>
</div>

<h2>üîç <%= t('search.title') %></h2>

<!-- Search form -->
<form method="GET" action="/forum/search" style="margin-bottom: 2rem;">
    <div class="form-group">
        <label for="q"><%= t('search.searchLabel') %>:</label>
        <div style="display: flex; gap: 0.5rem;">
            <input
                type="text"
                id="q"
                name="q"
                value="<%= typeof query !== 'undefined' ? query : '' %>"
                placeholder="<%= t('search.placeholder') %>"
                minlength="2"
                maxlength="100"
                required
                style="flex: 1;"
            >
            <button type="submit" class="btn">
                üîç <%= t('search.searchButton') %>
            </button>
        </div>
        <div class="text-small" style="margin-top: 0.5rem;">
            <%= t('search.helpText') %>
        </div>
    </div>

    <!-- Advanced search options -->
    <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; color: #3498db;"><%= t('search.advancedOptions') %></summary>
        <div style="margin-top: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 4px;">
            <div class="form-group">
                <label for="search_in"><%= t('search.searchIn') %>:</label>
                <select id="search_in" name="search_in">
                    <option value="all" <%= searchIn === 'all' ? 'selected' : '' %>><%= t('search.all') %></option>
                    <option value="title" <%= searchIn === 'title' ? 'selected' : '' %>><%= t('search.titlesOnly') %></option>
                    <option value="content" <%= searchIn === 'content' ? 'selected' : '' %>><%= t('search.contentOnly') %></option>
                    <option value="replies" <%= searchIn === 'replies' ? 'selected' : '' %>><%= t('search.repliesOnly') %></option>
                </select>
            </div>

            <div class="form-group">
                <label for="language"><%= t('search.language') %>:</label>
                <select id="language" name="language">
                    <option value="all" <%= (!language || language === 'all') ? 'selected' : '' %>><%= t('search.allLanguages') %></option>
                    <option value="fr" <%= language === 'fr' ? 'selected' : '' %>><%= t('languages.fr') %></option>
                    <option value="nl" <%= language === 'nl' ? 'selected' : '' %>><%= t('languages.nl') %></option>
                    <option value="en" <%= language === 'en' ? 'selected' : '' %>><%= t('languages.en') %></option>
                    <option value="de" <%= language === 'de' ? 'selected' : '' %>><%= t('languages.de') %></option>
                </select>
            </div>

            <div class="form-group">
                <label for="sort_by"><%= t('search.sortBy') %>:</label>
                <select id="sort_by" name="sort_by">
                    <option value="relevance" <%= sortBy === 'relevance' ? 'selected' : '' %>><%= t('search.relevance') %></option>
                    <option value="newest" <%= sortBy === 'newest' ? 'selected' : '' %>><%= t('search.newest') %></option>
                    <option value="oldest" <%= sortBy === 'oldest' ? 'selected' : '' %>><%= t('search.oldest') %></option>
                    <option value="replies" <%= sortBy === 'replies' ? 'selected' : '' %>><%= t('search.mostReplies') %></option>
                </select>
            </div>

            <div class="form-group">
                <label for="date_range"><%= t('search.period') %>:</label>
                <select id="date_range" name="date_range">
                    <option value="all" <%= dateRange === 'all' ? 'selected' : '' %>><%= t('search.allDates') %></option>
                    <option value="today" <%= dateRange === 'today' ? 'selected' : '' %>><%= t('search.today') %></option>
                    <option value="week" <%= dateRange === 'week' ? 'selected' : '' %>><%= t('search.thisWeek') %></option>
                    <option value="month" <%= dateRange === 'month' ? 'selected' : '' %>><%= t('search.thisMonth') %></option>
                    <option value="year" <%= dateRange === 'year' ? 'selected' : '' %>><%= t('search.thisYear') %></option>
                </select>
            </div>
        </div>
    </details>
</form>

<!-- Search results -->
<% if (typeof query !== 'undefined' && query) { %>
    <% if (results && results.length > 0) { %>
        <div style="margin-bottom: 1.5rem;">
            <p><strong><%= totalResults %></strong> <%= totalResults !== 1 ? t('search.results') : t('search.result') %> <%= t('search.for') %> "<%= query %>"</p>
        </div>

        <div class="thread-list">
            <% results.forEach(result => { %>
                <div class="thread-item <%= result.isPinned ? 'pinned' : '' %>">
                    <div class="thread-title">
                        <a href="<%= result.type === 'reply' ? '/forum/threads/' + result.threadId + '#reply-' + result.id : '/forum/threads/' + result.id %>">
                            <% if (result.type === 'reply') { %>
                                üí¨ Re:
                            <% } %>
                            <%- highlightSearchTerms(result.title, query) %>
                        </a>
                    </div>

                    <div class="thread-meta">
                        <span><%= t('search.by') %> <%= result.author || t('forum.deleted') %></span>
                        <% if (result.isModerator) { %>
                            <span class="moderator-badge">üõ°Ô∏è <%= t('moderation.moderator') %></span>
                        <% } %>
                        <span> ‚Ä¢ <%= result.createdAt %></span>
                        <% if (result.type === 'thread') { %>
                            <span> ‚Ä¢ <%= result.replyCount || 0 %> <%= result.replyCount !== 1 ? t('forum.replies') : t('forum.reply') %></span>
                        <% } %>
                        <% if (result.language && result.language !== 'fr') { %>
                            <span> ‚Ä¢ <%= getLanguageName(result.language) %></span>
                        <% } %>
                    </div>

                    <div class="thread-excerpt">
                        <%- highlightSearchTerms(result.excerpt, query) %>
                    </div>
                </div>
            <% }); %>
        </div>

        <!-- Pagination for search results -->
        <% if (totalPages && totalPages > 1) { %>
            <div class="pagination">
                <% const queryParams = `q=${encodeURIComponent(query)}&search_in=${searchIn}&language=${language}&sort_by=${sortBy}&date_range=${dateRange}`; %>

                <% if (currentPage > 1) { %>
                    <a href="/forum/search?<%= queryParams %>&page=1">¬´ <%= t('search.first') %></a>
                    <a href="/forum/search?<%= queryParams %>&page=<%= currentPage - 1 %>">‚Äπ <%= t('pagination.previous') %></a>
                <% } %>

                <% for(let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
                    <% if (i === currentPage) { %>
                        <span class="current"><%= i %></span>
                    <% } else { %>
                        <a href="/forum/search?<%= queryParams %>&page=<%= i %>"><%= i %></a>
                    <% } %>
                <% } %>

                <% if (currentPage < totalPages) { %>
                    <a href="/forum/search?<%= queryParams %>&page=<%= currentPage + 1 %>"><%= t('pagination.next') %> ‚Ä∫</a>
                    <a href="/forum/search?<%= queryParams %>&page=<%= totalPages %>"><%= t('search.last') %> ¬ª</a>
                <% } %>
            </div>
        <% } %>

    <% } else { %>
        <div class="no-results">
            <p style="font-size: 3rem; margin-bottom: 1rem;">üîç</p>
            <h3><%= t('search.noResults') %></h3>
            <p><%= t('search.noResultsFor') %> "<strong><%= query %></strong>"</p>
            <div style="margin-top: 1.5rem;">
                <p><strong><%= t('search.suggestions') %>:</strong></p>
                <ul style="text-align: left; display: inline-block; margin-top: 0.5rem;">
                    <li><%= t('search.suggestion1') %></li>
                    <li><%= t('search.suggestion2') %></li>
                    <li><%= t('search.suggestion3') %></li>
                    <li><%= t('search.suggestion4') %></li>
                </ul>
            </div>
        </div>
    <% } %>
<% } else { %>
    <!-- No search performed yet -->
    <div style="text-align: center; padding: 2rem;">
        <p style="font-size: 3rem; margin-bottom: 1rem;">üîç</p>
        <p><%= t('search.emptyState') %></p>
    </div>

    <!-- Popular search terms -->
    <% if (typeof popularSearches !== 'undefined' && popularSearches && popularSearches.length > 0) { %>
        <div style="margin-top: 2rem;">
            <h3><%= t('search.popularSearches') %>:</h3>
            <div style="margin-top: 1rem;">
                <% popularSearches.forEach(term => { %>
                    <a href="/forum/search?q=<%= encodeURIComponent(term) %>" class="btn btn-secondary" style="margin: 0.25rem;">
                        <%= term %>
                    </a>
                <% }); %>
            </div>
        </div>
    <% } %>
<% } %>

<!-- Helper functions (normally in backend, shown here for clarity) -->
<%
function highlightSearchTerms(text, searchQuery) {
    if (!text || !searchQuery) return text;

    const terms = searchQuery.split(' ').filter(term => term.length > 1);
    let highlightedText = text;

    terms.forEach(term => {
        const regex = new RegExp(`(${term})`, 'gi');
        highlightedText = highlightedText.replace(regex, '<span class="search-highlight">$1</span>');
    });

    return highlightedText;
}

function getLanguageName(code) {
    const languages = {
        'fr': 'Fran√ßais',
        'nl': 'Nederlands',
        'en': 'English',
        'de': 'Deutsch'
    };
    return languages[code] || code;
}
%>

<div class="alert alert-info" style="margin-top: 2rem;">
    <strong>üí° <%= t('search.tip') %>:</strong> <%= t('search.tipText') %>
</div>

<%- include('../partials/footer') %>