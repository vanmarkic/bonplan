<%- include('../partials/header', { title: t('threadEdit.pageTitle') }) %>

<!-- Breadcrumb navigation -->
<div style="margin-bottom: 1.5rem;">
    <a href="/forum/threads/<%= thread.id %>" style="color: #3498db; text-decoration: none;">‚Üê <%= t('actions.back') %> <%= t('forum.thread').toLowerCase() %></a>
</div>

<h2><%= t('threadEdit.title') %></h2>

<% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-error">
        <%= error %>
    </div>
<% } %>

<% if (thread.editTimeRemaining) { %>
    <div class="alert alert-info" style="margin-bottom: 2rem;">
        <strong>‚è±Ô∏è <%= t('threadEdit.timeRemaining') %>:</strong> <%= thread.editTimeRemaining %>
        <p style="margin-top: 0.5rem; font-size: 0.875rem;">
            <%= t('threadEdit.timeRemainingNote') %>
        </p>
    </div>
<% } else { %>
    <div class="alert alert-error" style="margin-bottom: 2rem;">
        <strong>‚ö†Ô∏è <%= t('threadEdit.timeExpired') %></strong>
        <p style="margin-top: 0.5rem;">
            <%= t('threadEdit.timeExpiredNote') %>
        </p>
        <a href="/forum/threads/<%= thread.id %>" class="btn btn-secondary" style="margin-top: 0.5rem;"><%= t('actions.back') %> <%= t('forum.thread').toLowerCase() %></a>
    </div>
<% } %>

<% if (thread.canEdit) { %>
    <form method="POST" action="/forum/threads/<%= thread.id %>/edit" onsubmit="return validateForm()">
        <input type="hidden" name="_method" value="PUT">

        <div class="form-group">
            <label for="title"><%= t('threadEdit.threadTitle') %>: *</label>
            <input
                type="text"
                id="title"
                name="title"
                required
                minlength="5"
                maxlength="200"
                value="<%= thread.title %>"
                onkeyup="updateTitleCount()"
            >
            <div class="char-counter">
                <span id="title-count">0</span> / 200 <%= t('threadEdit.characters') %> (<%= t('threadEdit.minimum') %> 5)
            </div>
        </div>

        <div class="form-group">
            <label for="content"><%= t('threadEdit.yourMessage') %>: *</label>
            <textarea
                id="content"
                name="content"
                required
                minlength="10"
                maxlength="10000"
                rows="12"
                onkeyup="updateContentCount()"
            ><%= thread.content %></textarea>
            <div class="char-counter">
                <span id="content-count">0</span> / 10000 <%= t('threadEdit.characters') %> (<%= t('threadEdit.minimum') %> 10)
            </div>
        </div>

        <div class="form-group">
            <label for="language"><%= t('threadEdit.threadLanguage') %>:</label>
            <select id="language" name="language">
                <option value="fr" <%= thread.language === 'fr' ? 'selected' : '' %>><%= t('languages.fr') %></option>
                <option value="nl" <%= thread.language === 'nl' ? 'selected' : '' %>><%= t('languages.nl') %></option>
                <option value="en" <%= thread.language === 'en' ? 'selected' : '' %>><%= t('languages.en') %></option>
                <option value="de" <%= thread.language === 'de' ? 'selected' : '' %>><%= t('languages.de') %></option>
            </select>
        </div>

        <div class="form-group">
            <label for="edit_reason"><%= t('threadEdit.editReason') %>:</label>
            <input
                type="text"
                id="edit_reason"
                name="edit_reason"
                maxlength="100"
                placeholder="<%= t('threadEdit.editReasonPlaceholder') %>"
            >
            <div class="text-small">
                <%= t('threadEdit.editReasonNote') %>
            </div>
        </div>

        <div style="margin-top: 2rem;">
            <button type="submit" class="btn">
                ‚úÖ <%= t('threadEdit.saveChanges') %>
            </button>
            <button type="button" onclick="if(confirm('<%= t('threadEdit.abandonConfirm') %>')) { window.location.href='/forum/threads/<%= thread.id %>'; }" class="btn btn-secondary" style="margin-left: 1rem;">
                ‚ùå <%= t('actions.cancel') %>
            </button>
        </div>
    </form>

    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #ccc;">
        <h3 style="color: #e74c3c;"><%= t('threadEdit.dangerZone') %></h3>
        <p style="margin-bottom: 1rem;"><%= t('threadEdit.irreversibleAction') %></p>
        <button onclick="deleteThread()" class="btn btn-danger">
            üóëÔ∏è <%= t('threadEdit.deleteThread') %>
        </button>
    </div>
<% } %>

<script>
// Initialize character counters on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTitleCount();
    updateContentCount();
    startEditTimer();
});

function updateTitleCount() {
    const input = document.getElementById('title');
    const count = input.value.length;
    const counter = document.getElementById('title-count');
    counter.textContent = count;

    const container = counter.parentElement;
    container.className = 'char-counter';

    if (count < 5) {
        container.className = 'char-counter error';
    } else if (count > 180) {
        container.className = 'char-counter warning';
    } else if (count > 195) {
        container.className = 'char-counter error';
    }
}

function updateContentCount() {
    const textarea = document.getElementById('content');
    const count = textarea.value.length;
    const counter = document.getElementById('content-count');
    counter.textContent = count;

    const container = counter.parentElement;
    container.className = 'char-counter';

    if (count < 10) {
        container.className = 'char-counter error';
    } else if (count > 9000) {
        container.className = 'char-counter warning';
    } else if (count > 9900) {
        container.className = 'char-counter error';
    }
}

function validateForm() {
    const title = document.getElementById('title').value;
    const content = document.getElementById('content').value;

    if (title.trim().length < 5) {
        alert('<%= t('threadEdit.titleTooShort') %>');
        return false;
    }

    if (content.trim().length < 10) {
        alert('<%= t('threadEdit.messageTooShort') %>');
        return false;
    }

    return confirm('<%= t('threadEdit.confirmSave') %>');
}

function deleteThread() {
    const confirmMsg = '<%= t('threadEdit.deleteWarning') %>';

    if (confirm(confirmMsg)) {
        if (confirm('<%= t('threadEdit.deleteLastChance') %>')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/forum/threads/<%= thread.id %>/delete';
            const method = document.createElement('input');
            method.type = 'hidden';
            method.name = '_method';
            method.value = 'DELETE';
            form.appendChild(method);
            document.body.appendChild(form);
            form.submit();
        }
    }
}

function startEditTimer() {
    <% if (thread.editTimeRemainingSeconds) { %>
        let seconds = <%= thread.editTimeRemainingSeconds %>;
        const timerElement = document.querySelector('.alert-info strong');

        if (timerElement) {
            const interval = setInterval(function() {
                seconds--;
                if (seconds <= 0) {
                    clearInterval(interval);
                    window.location.reload();
                } else {
                    const minutes = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    const timeStr = minutes > 0
                        ? `${minutes} <%= t('threadEdit.minute') %>${minutes !== 1 ? 's' : ''} ${secs} <%= t('threadEdit.second') %>${secs !== 1 ? 's' : ''}`
                        : `${secs} <%= t('threadEdit.second') %>${secs !== 1 ? 's' : ''}`;
                    timerElement.textContent = '‚è±Ô∏è <%= t('threadEdit.timeRemaining') %>: ' + timeStr;

                    // Change alert color when time is running out
                    if (seconds < 60) {
                        timerElement.parentElement.className = 'alert alert-error';
                    } else if (seconds < 180) {
                        timerElement.parentElement.style.background = '#fff3cd';
                        timerElement.parentElement.style.borderColor = '#ffc107';
                        timerElement.parentElement.style.color = '#856404';
                    }
                }
            }, 1000);
        }
    <% } %>
}
</script>

<%- include('../partials/footer') %>